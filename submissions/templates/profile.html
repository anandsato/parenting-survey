{% load staticfiles %}

<html>
<head>
	<title>
		Surveys
	</title>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
<link rel="stylesheet" type="text/css" href="{% static "css/bootstrap-slider.css" %}">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

<SCRIPT TYPE="text/javascript" SRC="{% static "js/bootstrap-slider.js" %}"></SCRIPT>
<SCRIPT TYPE="text/javascript" SRC="{% static "js/cookie.js" %}"></SCRIPT>


<STYLE TYPE="text/css">

body {
	background-color: black;
}

.container {
	background-color: white;
}


#exSlider .slider-selection {
	background: #BABABA;
}

</STYLE>


<body>
	<div class="container">
	<h2>Surveys</h2>


	<form id="survey" method="post" action="/">
		{% csrf_token %}
		    <label for="name">Name</label>
		    <input class="form-control" id="name" name="name" placeholder="What is your name?" width="100">


		{% for q in questions %}
		<div>

			<div>
				<b>Question {{ q.order }}:</b> {{ q.text }}
				<br><br>
				<div>
					<input class="bs-slider" id="ex{{ q.order }}" data-slider-id='ex{{ q.order }}Slider' type="text" data-slider-min="{{ q.min_value }}" data-slider-max="{{ q.max_value }}" data-slider-step="1" data-slider-value="5" name="{{ q.order }}">
					<span id="ex{{ q.order }}CurrentSliderValLabel">Your selection: <span id="ex{{ q.order }}SliderVal">5</span></span>	
				</div>
				<br>
			</div>
		</div>
		{% endfor %}
		<h4><div id="totalscore"></div>%</h4>
		<button type="submit" class="btn btn-default">Submit</button>
	</form>



	<SCRIPT TYPE="text/javascript">
	$(function(){

		function getCookie(name) {
		    var cookieValue = null;
		    if (document.cookie && document.cookie != '') {
		        var cookies = document.cookie.split(';');
		        for (var i = 0; i < cookies.length; i++) {
		            var cookie = jQuery.trim(cookies[i]);
		            // Does this cookie string begin with the name we want?
		            if (cookie.substring(0, name.length + 1) == (name + '=')) {
		                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                break;
		            }
		        }
		    }
		    return cookieValue;
		}
		var csrftoken = getCookie('csrftoken');

		function csrfSafeMethod(method) {
		    // these HTTP methods do not require CSRF protection
		    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
		}

		$.ajaxSetup({
		    beforeSend: function(xhr, settings) {
		        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
		            xhr.setRequestHeader("X-CSRFToken", csrftoken);
		        }
		    }
		});


		$("#survey").submit(function(event){
			event.preventDefault();
			var o = {};
			var a = $(this).serializeArray();
			console.log(JSON.stringify(a));
		    $.each(a, function() {
		    	o[this.name] = this.value || '';
		    	//console.log(JSON.stringify(this));
		        // if (o[this.name] !== undefined) {
		        //     if (!o[this.name].push) {
		        //         o[this.name] = [o[this.name]];
		        //     }
		        //     o[this.name].push(this.value || '');
		        //     console.log(this.value);
		        // } else {
		        //     o[this.name] = this.value || '';
		        // }
		    });
			$.post("/", {
				'json': o,
				'name': o["name"],
			});
		});


		$(".bs-slider").change(function(){
			var total = {{ questions|length }} * 10;
			var fraction = 100 / total;
			var score = 0;
			$(".bs-slider").each(function(i, obj){
				score = score + (obj.value * fraction);
			});
			score = Math.round( score * 10 ) / 10;
			$("#totalscore").html(score);
		});

	{% for q in questions %}

		var slider{{ q.order }} = new Slider('#ex{{ q.order }}', {
			formatter: function(value) {
				return 'Current value: ' + value;
			}
		});
		// $("#ex{{ q.order }}").slider();
		$("#ex{{ q.order }}").change(function() {
			$("#ex{{ q.order }}SliderVal").text(this.value);
		});

	
	{% endfor %}
	});
	</SCRIPT>


	</div>



</body>
</html>

